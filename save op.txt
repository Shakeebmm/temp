CREATE DEFINER=`olive`@`%` PROCEDURE `spr_SaveOP`(
IN p_in_pno varchar(50),
IN p_in_history LONGBLOB,
IN p_in_medicine LONGBLOB,
IN p_in_nextOPDate datetime,
IN p_in_isFollowUp tinyint
)
BEGIN

	declare p_id int;
    declare today date;
	declare p_medLength int;
	declare p_historyLength int;
    declare p_prev_history LONGBLOB;
    declare p_prev_medicine LONGBLOB;
    declare p_history_insert LONGBLOB;
    declare p_medicine_insert LONGBLOB;
    
    set p_medLength = ifnull(length(p_in_medicine),0);
    set p_historyLength = ifnull(length(p_in_history),0);
    
    select CURDATE() into today;
    
	SELECT Id into p_id FROM patient where PNo = p_in_pno; 

	IF EXISTS (SELECT 1 FROM op where PatientId = p_id and OPDate = today) 
    THEN	
		UPDATE op
			SET 
            NextOPDate = p_in_nextOPDate,
            IsFollowupRequired = p_in_isFollowUp
        WHERE PatientId = p_id
			and OPDate = today;
        
        IF p_medLength > 0 THEN
			UPDATE op SET Medicine = p_in_medicine WHERE PatientId = p_id and OPDate = today;
		END IF;
        
        IF p_historyLength > 0 THEN
			UPDATE op SET `History` = p_in_history WHERE PatientId = p_id and OPDate = today;
		END IF;
            
     ELSE
     
		select history, medicine into p_prev_history, p_prev_medicine   
        from op where patientid = p_id order by id desc limit 1;
        
         IF p_medLength > 0 THEN
			SET p_medicine_insert = p_in_medicine;
         ELSE
			SET p_medicine_insert = p_prev_medicine;
         END IF;
         
          IF p_historyLength > 0 THEN
			SET p_history_insert = p_in_history;
         ELSE
			SET p_history_insert = p_prev_history;
         END IF;
		
		INSERT INTO op
		(PatientId, `History`, Medicine, NextOPDate, IsFollowupRequired, OPDate)
		VALUES
		(p_id, p_history_insert, p_medicine_insert, p_in_nextOPDate, p_in_isFollowUp, today);
     END IF;
     
     
	DELETE FROM op
	WHERE 
	patientid = p_id and
	id NOT IN (
	  SELECT id FROM (
		select id from op where patientid = p_id order by Id desc limit 5
	  ) as t
	);

	

END